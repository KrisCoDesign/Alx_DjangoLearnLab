{% extends 'base.html' %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="post-detail-container">
    <article class="post-detail">
        <header class="post-header">
            <h1>{{ post.title }}</h1>
            <div class="post-meta">
                <span class="author">By {{ post.author.username }}</span>
                <span class="date">Published on {{ post.published_date|date:"F j, Y" }}</span>
                {% if post.author == user %}
                    <span class="author-badge">Your Post</span>
                {% endif %}
            </div>
        </header>
        
        <div class="post-content">
            {{ post.content|linebreaks }}
        </div>
        
        <footer class="post-footer">
            <div class="post-actions">
                <a href="{% url 'post_list' %}" class="btn btn-secondary">Back to Posts</a>
                {% if user == post.author %}
                    <a href="{% url 'post_update' post.pk %}" class="btn btn-warning">Edit Post</a>
                    <a href="{% url 'post_delete' post.pk %}" class="btn btn-danger">Delete Post</a>
                {% endif %}
            </div>
        </footer>
    </article>

    <!-- Comments Section -->
    <section id="comments" class="comments-section">
        <h2>Comments{% if comments %} ({{ comments|length }}){% endif %}</h2>

        {% if comments %}
            <ul class="comment-list">
                {% for comment in comments %}
                    <li class="comment" id="comment-{{ comment.pk }}">
                        <div class="comment-meta">
                            <span class="author">{{ comment.author.username }}</span>
                            <span class="date">{{ comment.created_at|date:"F j, Y, g:i a" }}</span>
                            {% if user == comment.author %}
                                <span class="comment-actions">
                                    <button class="btn btn-sm btn-warning edit-comment-btn" data-comment-id="{{ comment.pk }}">Edit</button>
                                    <a href="{% url 'comment_delete' comment.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this comment?')">Delete</a>
                                </span>
                            {% endif %}
                        </div>
                        
                        <!-- Comment Display -->
                        <div class="comment-body" id="comment-body-{{ comment.pk }}">
                            {{ comment.content|linebreaks }}
                        </div>
                        
                        <!-- Comment Edit Form (Hidden by default) -->
                        <div class="comment-edit-form" id="comment-edit-{{ comment.pk }}" style="display: none;">
                            <form method="post" action="{% url 'comment_update' comment.pk %}" class="inline-edit-form">
                                {% csrf_token %}
                                <div class="form-group">
                                    <textarea name="content" class="form-control" rows="3" required>{{ comment.content }}</textarea>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" data-comment-id="{{ comment.pk }}">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="no-comments">No comments yet. Be the first to comment!</p>
        {% endif %}

        {% if user.is_authenticated %}
            <form method="post" action="{% url 'comment_create' post.pk %}" class="comment-form">
                {% csrf_token %}
                {% if form and form.non_field_errors %}
                    <div class="error-message">{{ form.non_field_errors }}</div>
                {% endif %}

                <div class="form-group">
                    {% if form and form.content %}
                        <label for="{{ form.content.id_for_label }}">Add a comment</label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="error-message">{{ form.content.errors }}</div>
                        {% endif %}
                    {% else %}
                        <label for="id_content">Add a comment</label>
                        <textarea name="content" id="id_content" rows="3" class="form-control" placeholder="Write your comment..."></textarea>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>
        {% else %}
            <p><a href="{% url 'login' %}">Log in</a> to post a comment.</p>
        {% endif %}
    </section>
</div>

<script>
// JavaScript for inline comment editing
document.addEventListener('DOMContentLoaded', function() {
    // Edit comment functionality
    document.querySelectorAll('.edit-comment-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const commentBody = document.getElementById('comment-body-' + commentId);
            const editForm = document.getElementById('comment-edit-' + commentId);
            
            commentBody.style.display = 'none';
            editForm.style.display = 'block';
            this.style.display = 'none';
        });
    });
    
    // Cancel edit functionality
    document.querySelectorAll('.cancel-edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const commentId = this.getAttribute('data-comment-id');
            const commentBody = document.getElementById('comment-body-' + commentId);
            const editForm = document.getElementById('comment-edit-' + commentId);
            const editBtn = document.querySelector('.edit-comment-btn[data-comment-id="' + commentId + '"]');
            
            commentBody.style.display = 'block';
            editForm.style.display = 'none';
            editBtn.style.display = 'inline-block';
        });
    });
});
</script>
{% endblock %}


